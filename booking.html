<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">حجز كشف طبي - GovHealthcare</title>
    <!-- Bootstrap RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Booking Form CSS -->
    <link rel="stylesheet" href="assets/css/pages/booking-form.css">
</head>
<body data-page="booking-dynamic">
    <!-- Header will be inserted here by JavaScript -->
    <header id="header"></header>

    <main class="container py-4">
        <div class="booking-container">
            <h1 id="typewriter" class="text-center mb-4"></h1>
            <div id="booking-form">
                <!-- Form will be inserted here by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Footer will be inserted here by JavaScript -->
    <footer id="footer"></footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    
    <!-- Dynamic Booking Page Logic -->
    <script type="module">
        import { createHeader } from './components/common/header.js';
        import { createFooter } from './components/common/footer.js';
        import { showLoading } from './components/ui/loading.js';
        import { getAllAgeGroups } from './data/age-groups.js';
        import { getHospitalBySlug, getAllHospitals } from './data/hospitals.js';
        import { getSpecialtyBySlug, getAllSpecialties } from './data/specialties.js';
        import { bookingConfig } from './data/booking-config.js';
        
        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Initialize the dynamic booking page
        async function initDynamicBookingPage() {
            try {
                showLoading(true);
                
                // Get parameters from URL
                const hospitalSlug = getUrlParameter('hospital');
                const ageGroupId = getUrlParameter('age');
                const specialtySlug = getUrlParameter('specialty');
                
                // Get all age groups as array
                const ageGroupsArray = getAllAgeGroups();
                
                // Find context objects
                let hospital = hospitalSlug ? getHospitalBySlug(hospitalSlug) : null;
                let ageGroup = ageGroupId ? ageGroupsArray.find(g => g.id === ageGroupId || g.slug === ageGroupId) : null;
                let specialty = specialtySlug ? getSpecialtyBySlug(specialtySlug) : null;
                
                // Default to adult if no age group specified
                if (!ageGroup) {
                    ageGroup = ageGroupsArray.find(g => g.id === 'adult' || g.slug === 'middle') || ageGroupsArray[0];
                }
                
                // Update page title and content
                updatePageTitle(ageGroup, hospital, specialty);
                
                // Initialize header and footer
                const headerContainer = document.getElementById('header');
                const footerContainer = document.getElementById('footer');
                
                if (headerContainer) {
                    createHeader(headerContainer, {
                        title: 'GovHealthcare',
                        logo: 'hospital',
                        fixed: true,
                        showThemeToggle: false,
                        showLanguageToggle: true,
                        onLanguageChange: (lang) => {
                            document.documentElement.lang = lang;
                            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                            localStorage.setItem('language', lang);
                        }
                    });
                }
                
                if (footerContainer) {
                    createFooter(footerContainer);
                }
                
                // Create typewriter title
                createTypewriterTitle(ageGroup, hospital, specialty);
                
                // Create booking form
                createBookingForm(ageGroup, hospital, specialty);
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading booking page:', error);
                showLoading(false);
                showErrorPage(error.message);
            }
        }
        
        // Update page title
        function updatePageTitle(ageGroup, hospital, specialty) {
            let title = 'حجز كشف طبي';
            
            if (specialty) {
                title = `حجز موعد - ${specialty.nameAr}`;
            } else if (hospital) {
                title = `حجز موعد - ${hospital.nameAr}`;
            } else if (ageGroup) {
                title = `حجز كشف طبي - ${ageGroup.nameAr || ageGroup.name}`;
            }
            
            document.title = `${title} - GovHealthcare`;
            document.getElementById('page-title').textContent = `${title} - GovHealthcare`;
        }
        
        // Create typewriter animated title
        function createTypewriterTitle(ageGroup, hospital, specialty) {
            const typewriterElement = document.getElementById('typewriter');
            
            let titleText = '';
            if (specialty && hospital) {
                titleText = `Book ${specialty.name} Appointment at ${hospital.name}`;
            } else if (hospital) {
                titleText = `Book Medical Appointment at ${hospital.name}`;
            } else if (specialty) {
                titleText = `Book ${specialty.name} Appointment`;
            } else {
                titleText = `Book Medical Appointment - ${ageGroup.name}`;
            }
            
            typewriterEffect(typewriterElement, titleText);
        }
        
        // Typewriter effect animation
        function typewriterEffect(element, text, speed = 100) {
            element.innerHTML = '';
            let i = 0;
            
            function typeChar() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(typeChar, speed);
                } else {
                    // Add cursor at the end
                    element.innerHTML += '<span class="typing-cursor">|</span>';
                }
            }
            
            typeChar();
        }
        
        // Create booking form
        function createBookingForm(ageGroup, hospital, specialty) {
            const formContainer = document.getElementById('booking-form');
            
            const form = document.createElement('form');
            form.id = 'appointmentForm';
            form.className = 'needs-validation';
            form.noValidate = true;
            
            // Create form sections
            form.innerHTML = `
                ${createPersonalInfoSection()}
                ${createAppointmentSection(hospital, specialty)}
                ${createMedicalInfoSection()}
                ${createSubmitSection()}
            `;
            
            formContainer.appendChild(form);
            
            // Initialize form functionality
            initializeForm(ageGroup, hospital, specialty);
        }
        
        // Create personal information section
        function createPersonalInfoSection() {
            const personalFields = bookingConfig.commonFields;
            
            return `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-person-fill me-2"></i>
                            Personal Information / المعلومات الشخصية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            ${personalFields.map(field => createFormField(field)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Create appointment scheduling section
        function createAppointmentSection(hospital, specialty) {
            return `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check me-2"></i>
                            Appointment Details / تفاصيل الموعد
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            ${createHospitalField(hospital)}
                            ${createSpecialtyField(specialty, hospital)}
                            ${createDateField()}
                            ${createTimeField()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Create medical information section
        function createMedicalInfoSection() {
            const medicalFields = bookingConfig.medicalFields;
            
            return `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-pulse me-2"></i>
                            Medical Information / المعلومات الطبية
                            <small class="text-muted">(Optional - اختياري)</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            ${medicalFields.map(field => createFormField(field)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Create submit section
        function createSubmitSection() {
            return `
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-check-circle me-2"></i>
                        Book Appointment / احجز موعدك
                    </button>
                    <div class="mt-3">
                        <small class="text-muted">
                            By booking, you agree to our terms and conditions / 
                            بالحجز، توافق على الشروط والأحكام
                        </small>
                    </div>
                </div>
            `;
        }
        
        // Create form field HTML
        function createFormField(field) {
            const colClass = field.type === 'textarea' ? 'col-12' : 'col-md-6';
            
            if (field.type === 'select') {
                return `
                    <div class="${colClass}">
                        <label for="${field.name}" class="form-label">
                            ${field.label} / ${field.labelAr}
                            ${field.required ? '<span class="text-danger">*</span>' : ''}
                        </label>
                        <select class="form-select" id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                            <option value="">Choose... / Ø§Ø®ØªØ±...</option>
                            ${field.options ? field.options.map(option => 
                                `<option value="${option.value}">${option.label} / ${option.labelAr}</option>`
                            ).join('') : ''}
                        </select>
                        <div class="invalid-feedback">
                            ${field.validation?.errorMessage} / ${field.validation?.errorMessageAr}
                        </div>
                    </div>
                `;
            } else if (field.type === 'textarea') {
                return `
                    <div class="${colClass}">
                        <label for="${field.name}" class="form-label">
                            ${field.label} / ${field.labelAr}
                            ${field.required ? '<span class="text-danger">*</span>' : ''}
                        </label>
                        <textarea class="form-control" id="${field.name}" name="${field.name}" 
                                  rows="3" placeholder="${field.placeholder} / ${field.placeholderAr}"
                                  ${field.required ? 'required' : ''}></textarea>
                        <div class="invalid-feedback">
                            ${field.validation?.errorMessage} / ${field.validation?.errorMessageAr}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="${colClass}">
                        <label for="${field.name}" class="form-label">
                            ${field.label} / ${field.labelAr}
                            ${field.required ? '<span class="text-danger">*</span>' : ''}
                        </label>
                        <input type="${field.type}" class="form-control" 
                               id="${field.name}" name="${field.name}"
                               placeholder="${field.placeholder || ''} / ${field.placeholderAr || ''}"
                               ${field.required ? 'required' : ''}>
                        <div class="invalid-feedback">
                            ${field.validation?.errorMessage} / ${field.validation?.errorMessageAr}
                        </div>
                    </div>
                `;
            }
        }
        
        // Create hospital selection field
        function createHospitalField(preselectedHospital) {
            const hospitals = getAllHospitals();
            
            return `
                <div class="col-md-6">
                        <label for="hospital" class="form-label">
                        Select Hospital / اختر المستشفى
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="hospital" name="hospital" required>
                        <option value="">Choose Hospital... / اختر المستشفى...</option>
                        ${hospitals.map(hospital => 
                            `<option value="${hospital.urlSlug}" ${preselectedHospital?.urlSlug === hospital.urlSlug ? 'selected' : ''}>
                                ${hospital.name} / ${hospital.nameAr}
                            </option>`
                        ).join('')}
                    </select>
                    <div class="invalid-feedback">
                        Please select a hospital / يرجى اختيار مستشفى
                    </div>
                </div>
            `;
        }
        
        // Create specialty selection field
        function createSpecialtyField(preselectedSpecialty, hospital) {
            const specialties = hospital ? hospital.specialties : getAllSpecialties().map(s => s.slug);
            const allSpecialties = getAllSpecialties();
            
            return `
                <div class="col-md-6">
                        <label for="specialty" class="form-label">
                        Medical Specialty / التخصص الطبي
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="specialty" name="specialty" required>
                        <option value="">Choose Specialty... / اختر التخصص...</option>
                        ${specialties.map(specialtySlug => {
                            const specialty = allSpecialties.find(s => s.slug === specialtySlug);
                            return specialty ? `<option value="${specialty.slug}" ${preselectedSpecialty?.slug === specialty.slug ? 'selected' : ''}>
                                ${specialty.name} / ${specialty.nameAr}
                            </option>` : '';
                        }).join('')}
                    </select>
                    <div class="invalid-feedback">
                        Please select a medical specialty / يرجى اختيار تخصص طبي
                    </div>
                </div>
            `;
        }
        
        // Create date field
        function createDateField() {
            const today = new Date().toISOString().split('T')[0];
            const maxDate = new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            return `
                <div class="col-md-6">
                        <label for="preferredDate" class="form-label">
                        Preferred Date / التاريخ المفضل
                        <span class="text-danger">*</span>
                    </label>
                    <input type="date" class="form-control" id="preferredDate" name="preferredDate" 
                           min="${today}" max="${maxDate}" required>
                    <div class="invalid-feedback">
                        Please select a valid appointment date / يرجى اختيار تاريخ موعد صحيح
                    </div>
                </div>
            `;
        }
        
        // Create time field
        function createTimeField() {
            const timeSlots = bookingConfig.appointmentFields.find(f => f.name === 'preferredTime').options;
            
            return `
                <div class="col-md-6">
                    <label for="preferredTime" class="form-label">
                        Preferred Time / الوقت المفضل
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="preferredTime" name="preferredTime" required>
                        <option value="">Choose Time... / اختر الوقت...</option>
                        ${timeSlots.map(time => 
                            `<option value="${time.value}">${time.label} / ${time.labelAr}</option>`
                        ).join('')}
                    </select>
                    <div class="invalid-feedback">
                        Please select a preferred time / يرجى اختيار وقت مفضل
                    </div>
                </div>
            `;
        }
        
        // Initialize form functionality
        function initializeForm(ageGroup, hospital, specialty) {
            const form = document.getElementById('appointmentForm');
            
            // Form submission handler
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                if (form.checkValidity()) {
                    handleFormSubmission(form, ageGroup, hospital, specialty);
                } else {
                    form.classList.add('was-validated');
                }
            });
            
            // Dynamic specialty updates based on hospital selection
            const hospitalSelect = document.getElementById('hospital');
            const specialtySelect = document.getElementById('specialty');
            
            hospitalSelect.addEventListener('change', function() {
                updateSpecialtyOptions(this.value, specialtySelect, specialty);
            });
        }
        
        // Update specialty options based on hospital selection
        function updateSpecialtyOptions(hospitalSlug, specialtySelect, preselectedSpecialty) {
            const hospital = getHospitalBySlug(hospitalSlug);
            const allSpecialties = getAllSpecialties();
            
            // Clear existing options
            specialtySelect.innerHTML = '<option value="">Choose Specialty... / اختر التخصص...</option>';
            
            if (hospital) {
                hospital.specialties.forEach(specialtySlug => {
                    const specialty = allSpecialties.find(s => s.slug === specialtySlug);
                    if (specialty) {
                        const option = document.createElement('option');
                        option.value = specialty.slug;
                        option.textContent = `${specialty.name} / ${specialty.nameAr}`;
                        if (preselectedSpecialty?.slug === specialty.slug) {
                            option.selected = true;
                        }
                        specialtySelect.appendChild(option);
                    }
                });
            }
        }
        
        // Handle form submission
        function handleFormSubmission(form, ageGroup, hospital, specialty) {
            const formData = new FormData(form);
            const appointmentData = Object.fromEntries(formData.entries());
            
            // Add context data
            appointmentData.ageGroup = ageGroup.id;
            appointmentData.bookingTimestamp = new Date().toISOString();
            
            // Show success message
            showBookingConfirmation(appointmentData);
        }
        
        // Show booking confirmation
        function showBookingConfirmation(appointmentData) {
            const formContainer = document.getElementById('booking-form');
            
            formContainer.innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h2 class="text-success mb-3">Booking Confirmed! / تم تأكيد الحجز!</h2>
                    <p class="lead mb-4">
                        Your appointment has been successfully booked.<br>
                        تم حجز موعدك بنجاح.
                    </p>
                    <div class="card mx-auto mb-4" style="max-width: 500px;">
                        <div class="card-body">
                            <h5 class="card-title">Appointment Details / تفاصيل الموعد</h5>
                            <p class="card-text">
                                <strong>Date / التاريخ:</strong> ${appointmentData.preferredDate}<br>
                                <strong>Time / الوقت:</strong> ${appointmentData.preferredTime}<br>
                                <strong>Hospital / المستشفى:</strong> ${appointmentData.hospital}<br>
                                <strong>Specialty / التخصص:</strong> ${appointmentData.specialty}
                            </p>
                        </div>
                    </div>
                    <div class="d-flex gap-3 justify-content-center">
                        <a href="index.html" class="btn btn-primary">
                            <i class="bi bi-house me-1"></i>
                            Home / الرئيسية
                        </a>
                        <a href="hospitals.html" class="btn btn-outline-primary">
                            <i class="bi bi-hospital me-1"></i>
                            Hospitals / المستشفيات
                        </a>
                    </div>
                </div>
            `;
        }
        
        // Show error page
        function showErrorPage(message) {
            const main = document.querySelector('main');
            main.innerHTML = `
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="alert alert-danger text-center">
                                <h4 class="alert-heading">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Booking Error
                                </h4>
                                <p class="mb-3">${message}</p>
                                <hr>
                                <div class="mb-0">
                                    <a href="hospitals.html" class="btn btn-primary me-2">
                                        <i class="bi bi-arrow-left me-1"></i>
                                        Back to Hospitals
                                    </a>
                                    <a href="index.html" class="btn btn-outline-primary">
                                        <i class="bi bi-house me-1"></i>
                                        Home
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initDynamicBookingPage);
    </script>
    
    <!-- Global bootstrap router -->
    <!-- Base Template System -->
<script type="module">
    import { initBaseTemplate, getStandardImportMap } from './templates/base-template.js';
    
    const importMapScript = document.createElement('script');
    importMapScript.type = 'importmap';
    importMapScript.textContent = JSON.stringify(getStandardImportMap(), null, 4);
    document.head.appendChild(importMapScript);
    
    initBaseTemplate({
        title: 'GovHealthcare',
        logo: 'hospital'
    });
</script>
</body>
</html>
