<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Hospital - GovHealthcare</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Hospital Layout CSS -->
    <link rel="stylesheet" href="assets/css/pages/hospital-layout.css">
    <!-- Specialty Cards CSS -->
    <link rel="stylesheet" href="assets/css/components/specialty-cards.css">
</head>
<body data-page="hospital-dynamic">
    <!-- App container where content will be injected -->
    <div id="app">
        <!-- Header will be inserted here by JavaScript -->
        <header id="header"></header>
        
        <!-- Main content will be inserted here -->
        <main></main>
        
        <!-- Footer will be inserted here -->
        <footer id="footer"></footer>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Import maps for module resolution -->
    <script type="importmap">
    {
        "imports": {
            "@/core/dom": "./core/dom.js",
            "@/ui/header": "./components/common/header.js",
            "@/ui/footer": "./components/common/footer.js",
            "@/ui/loading": "./components/ui/loading.js",
            "@/data/age-groups": "./data/age-groups.js",
            "@/data/hospitals": "./data/hospitals.js",
            "@/data/specialties": "./data/specialties.js",
            "@/data/hospital-specialties": "./data/hospital-specialties.js",
            "@/pages/specialty-display": "./pages/hospitals/specialty-display.js"
        }
    }
    </script>
    
    <!-- Dynamic Hospital Page Logic -->
    <script type="module">
        import { showLoading } from './components/ui/loading.js';
        import { getHospitalBySlug, getHospitalById } from './data/hospitals.js';
        import { getAllAgeGroups } from './data/age-groups.js';
        import { getSpecialtyBySlug } from './data/specialties.js';
        
        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Initialize the dynamic hospital page
        async function initDynamicHospitalPage() {
            try {
                showLoading(true);
                
                // Get hospital from URL parameters
                const hospitalName = getUrlParameter('name');
                const hospitalId = getUrlParameter('id');
                const specialtyParam = getUrlParameter('specialty');
                
                if (!hospitalName && !hospitalId) {
                    throw new Error('Hospital name or ID is required');
                }
                
                // Find hospital by name or ID
                let hospital = null;
                if (hospitalName) {
                    hospital = getHospitalBySlug(hospitalName);
                } else if (hospitalId) {
                    hospital = getHospitalById(hospitalId);
                }
                
                if (!hospital) {
                    throw new Error(`Hospital not found: ${hospitalName || hospitalId}`);
                }
                
                // Update page title
                document.title = `${hospital.name} - GovHealthcare`;
                document.getElementById('page-title').textContent = `${hospital.name} - GovHealthcare`;
                
                // Apply hospital theme
                applyHospitalTheme(hospital);
                
                // Initialize base template components
                const { initBaseTemplate } = await import('./templates/base-template.js');
                initBaseTemplate({
                    title: 'GovHealthcare',
                    logo: 'hospital',
                    fixed: true
                });
                
                // Create main content
                const main = document.querySelector('main');
                main.className = 'container py-4';
                main.innerHTML = createHospitalContent(hospital, specialtyParam);
                
                // Check if we should show specialties
                const urlParams = new URLSearchParams(window.location.search);
                const showSpecialties = urlParams.get('view') === 'specialties';
                
                if (showSpecialties) {
                    // Load specialty display module and show specialties
                    import('./pages/hospitals/specialty-display.js').then(({ createSpecialtyGrid }) => {
                        const container = document.getElementById('specialty-cards-container');
                        if (container) {
                            createSpecialtyGrid(hospital.urlSlug, container, {
                                showHeader: true,
                                showBackButton: false,
                                animationDelay: 100
                            });
                        }
                    }).catch(error => {
                        console.error('Error loading specialty display:', error);
                    });
                } else {
                    // Add event listeners for age group selection
                    addAgeGroupListeners(hospital);
                }
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading hospital page:', error);
                showLoading(false);
                showErrorPage(error.message);
            }
        }
        
        // Apply hospital-specific theme
        function applyHospitalTheme(hospital) {
            const root = document.documentElement;
            root.style.setProperty('--hospital-primary', hospital.primaryColor);
            root.style.setProperty('--hospital-secondary', hospital.secondaryColor);
            root.style.setProperty('--hospital-accent', hospital.accentColor);
        }
        
        // Create hospital content HTML
        function createHospitalContent(hospital, specialtyParam) {
            let pageTitle = '';
            let contentSection = '';
            
            // Check if we should show specialties directly
            const urlParams = new URLSearchParams(window.location.search);
            const showSpecialties = urlParams.get('view') === 'specialties';
            
            // Check if we're showing a specific specialty
            if (specialtyParam) {
                const specialty = getSpecialtyBySlug(specialtyParam);
                if (specialty) {
                    pageTitle = `
                        <div class="text-center mb-4">
                            <div class="d-flex align-items-center justify-content-center mb-3">
                                <div class="me-3" style="color: ${specialty.color};">
                                    <i class="bi bi-${specialty.icon}" style="font-size: 2rem;"></i>
                                </div>
                                <div>
                                    <h1 class="h2 mb-0">${specialty.name}</h1>
                                    <div class="text-muted">${specialty.nameAr}</div>
                                </div>
                            </div>
                            <div class="text-muted">${hospital.name}</div>
                        </div>
                    `;
                    
                    contentSection = `
                        <div class="alert alert-info mb-4">
                            <h5>About ${specialty.name} Services</h5>
                            <p>${specialty.description || `Our ${specialty.name} department provides comprehensive care and treatment for all related conditions.`}</p>
                            <p>Our team of specialists is dedicated to delivering the highest quality of care using the latest medical advancements.</p>
                            <p>Please select an age group below to proceed with booking an appointment.</p>
                        </div>
                    `;
                } else {
                    pageTitle = `<h1 class="text-center mb-4">${hospital.name}</h1>`;
                }
            } else {
                pageTitle = `<h1 class="text-center mb-4">${hospital.name}</h1>`;
                
                contentSection = `
                    <div class="row mb-4">
                        <div class="col-md-8 mx-auto">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="bi bi-${hospital.icon}" style="font-size: 3rem; color: ${hospital.primaryColor};"></i>
                                    </div>
                                    <h3>${hospital.name}</h3>
                                    <p class="text-muted mb-3">${hospital.nameAr}</p>
                                    <p class="mb-3">${hospital.description}</p>
                                    <div class="row text-start">
                                        <div class="col-sm-6">
                                            <p class="mb-2">
                                                <i class="bi bi-telephone me-2"></i>
                                                <strong>Phone:</strong> ${hospital.phone}
                                            </p>
                                        </div>
                                        <div class="col-sm-6">
                                            <p class="mb-2">
                                                <i class="bi bi-geo-alt me-2"></i>
                                                <strong>Address:</strong> ${hospital.address}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <a href="hospital.html?name=${hospital.urlSlug}&view=specialties" class="btn btn-outline-primary me-2">
                                            <i class="bi bi-grid me-1"></i>
                                            View Specialties
                                        </a>
                                        <span class="text-muted">Browse our medical specialties</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // If showing specialties, return different content
            if (showSpecialties) {
                return `
                    <div class="mb-4">
                        <a href="hospital.html?name=${hospital.urlSlug}" class="back-to-hospital">
                            <i class="bi bi-arrow-left me-1"></i>
                            Back to Hospital Overview
                        </a>
                    </div>
                    <div id="specialty-cards-container">
                        <!-- Specialty cards will be loaded here -->
                    </div>
                `;
            }
            
            return `
                ${pageTitle}
                ${contentSection}
                <section class="age-selection">
                    <h2 class="text-center mb-4">Select Age Group to Continue</h2>
                    <div class="row g-4 justify-content-center">
                        ${createAgeGroupCards()}
                    </div>
                </section>
            `;
        }
        
        // Create age group selection cards
        function createAgeGroupCards() {
            const ageGroupsArray = getAllAgeGroups();
            return ageGroupsArray.map(group => `
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 border-0 shadow-sm age-group-card" data-group-id="${group.id}" style="cursor: pointer;">
                        <div class="card-body text-center p-4">
                            <i class="bi ${group.icon} display-4 mb-3" style="color: var(--hospital-primary, var(--bs-primary));"></i>
                            <h3 class="h5 mb-2">${group.name}</h3>
                            <p class="text-muted mb-0">${group.ageRange || group.range || 'All ages'}</p>
                            <div class="mt-3">
                                <span class="btn btn-sm btn-outline-primary">Select <i class="bi bi-arrow-right ms-1"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Add event listeners for age group selection
        function addAgeGroupListeners(hospital) {
            const ageGroupCards = document.querySelectorAll('.age-group-card');
            ageGroupCards.forEach(card => {
                card.addEventListener('click', () => {
                    const groupId = card.dataset.groupId;
                    const ageGroupsArray = getAllAgeGroups();
                    const group = ageGroupsArray.find(g => g.id === groupId);
                    if (group) {
                        // Navigate to booking page with hospital and age group parameters
                        const url = `booking.html?hospital=${hospital.urlSlug}&age=${group.id}`;
                        window.location.href = url;
                    }
                });
                
                // Add hover effect
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-5px)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                });
            });
        }
        
        // Show error page
        function showErrorPage(message) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="alert alert-danger text-center">
                                <h4 class="alert-heading">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Hospital Not Found
                                </h4>
                                <p class="mb-3">${message}</p>
                                <hr>
                                <div class="mb-0">
                                    <a href="hospitals.html" class="btn btn-primary me-2">
                                        <i class="bi bi-arrow-left me-1"></i>
                                        Back to Hospitals
                                    </a>
                                    <a href="index.html" class="btn btn-outline-primary">
                                        <i class="bi bi-house me-1"></i>
                                        Home
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initDynamicHospitalPage);
    </script>
</body>
</html>